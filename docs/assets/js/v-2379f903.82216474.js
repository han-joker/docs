"use strict";(self.webpackChunkhan_joker_docs=self.webpackChunkhan_joker_docs||[]).push([[358],{1538:(n,s,e)=>{e.r(s),e.d(s,{data:()=>a});const a={key:"v-2379f903",path:"/nginx/http.html",title:"HTTP Server",lang:"zh-CN",frontmatter:{},excerpt:"",headers:[{level:2,title:"搭建 HTTP/2 服务器",slug:"搭建-http-2-服务器",children:[{level:3,title:"安装 http_v2 模块",slug:"安装-http-v2-模块",children:[]},{level:3,title:"配置服务，启用 h2",slug:"配置服务-启用-h2",children:[]},{level:3,title:"配置 SSL",slug:"配置-ssl",children:[]},{level:3,title:"浏览器测试",slug:"浏览器测试",children:[]},{level:3,title:"为什么浏览器知道需要使用 h2 协议来请求呢？",slug:"为什么浏览器知道需要使用-h2-协议来请求呢",children:[]},{level:3,title:"HTTP2 相关配置",slug:"http2-相关配置",children:[]}]}],filePathRelative:"nginx/http.md",git:{updatedTime:null}}},6833:(n,s,e)=>{e.r(s),e.d(s,{default:()=>K});var a=e(6252),l=e(3445);const m=(0,a.Wm)("h1",{id:"http-server",tabindex:"-1"},[(0,a.Wm)("a",{class:"header-anchor",href:"#http-server","aria-hidden":"true"},"#"),(0,a.Uk)(" HTTP Server")],-1),t=(0,a.Wm)("h2",{id:"搭建-http-2-服务器",tabindex:"-1"},[(0,a.Wm)("a",{class:"header-anchor",href:"#搭建-http-2-服务器","aria-hidden":"true"},"#"),(0,a.Uk)(" 搭建 HTTP/2 服务器")],-1),r=(0,a.Wm)("h3",{id:"安装-http-v2-模块",tabindex:"-1"},[(0,a.Wm)("a",{class:"header-anchor",href:"#安装-http-v2-模块","aria-hidden":"true"},"#"),(0,a.Uk)(" 安装 http_v2 模块")],-1),c=(0,a.Wm)("p",null,[(0,a.Uk)("Nginx 需要 "),(0,a.Wm)("code",null,"http_v2_module"),(0,a.Uk)(" 和 "),(0,a.Wm)("code",null,"http_ssl_module"),(0,a.Uk)(" 的支持，需要 Nginx >= 1.9.5。")],-1),i=(0,a.Wm)("p",null,[(0,a.Uk)("命令 "),(0,a.Wm)("code",null,"nginx -V"),(0,a.Uk)(" 可以确定版本和安装了某个模块：")],-1),W=(0,a.Wm)("div",{class:"language-bash ext-sh line-numbers-mode"},[(0,a.Wm)("pre",{class:"language-bash"},[(0,a.Wm)("code",null,[(0,a.Uk)("root@cd13571cd8c1:/"),(0,a.Wm)("span",{class:"token comment"},"# nginx -V"),(0,a.Uk)("\nnginx version: nginx/1.21.1\nbuilt by gcc "),(0,a.Wm)("span",{class:"token number"},"8.3"),(0,a.Uk)(".0 "),(0,a.Wm)("span",{class:"token punctuation"},"("),(0,a.Uk)("Debian "),(0,a.Wm)("span",{class:"token number"},"8.3"),(0,a.Uk)(".0-6"),(0,a.Wm)("span",{class:"token punctuation"},")"),(0,a.Uk)("\nbuilt with OpenSSL "),(0,a.Wm)("span",{class:"token number"},"1.1"),(0,a.Uk)(".1d  "),(0,a.Wm)("span",{class:"token number"},"10"),(0,a.Uk)(" Sep "),(0,a.Wm)("span",{class:"token number"},"2019"),(0,a.Uk)("\nTLS SNI support enabled\nconfigure arguments: --prefix"),(0,a.Wm)("span",{class:"token operator"},"="),(0,a.Uk)("/etc/nginx --with-http_ssl_module --with-http_v2_module "),(0,a.Wm)("span",{class:"token punctuation"},".."),(0,a.Uk)(".\n"),(0,a.Wm)("span",{class:"token comment"},"# 其他配置项略"),(0,a.Uk)("\n")])]),(0,a.Wm)("div",{class:"line-numbers"},[(0,a.Wm)("span",{class:"line-number"},"1"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"2"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"3"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"4"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"5"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"6"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"7"),(0,a.Wm)("br")])],-1),p=(0,a.Wm)("p",null,"若未安装相应模块，编译安装时需要使用下面的参数进行配置：",-1),u=(0,a.Wm)("div",{class:"language-text ext-text line-numbers-mode"},[(0,a.Wm)("pre",{class:"language-text"},[(0,a.Wm)("code",null,"./configure --with-http_ssl_module --with-http_v2_module\nmake && make install\n")]),(0,a.Wm)("div",{class:"line-numbers"},[(0,a.Wm)("span",{class:"line-number"},"1"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"2"),(0,a.Wm)("br")])],-1),o=(0,a.Wm)("p",null,"windows 下的二进制发行版，内置了该模块，直接使用即可！",-1),k=(0,a.Wm)("h3",{id:"配置服务-启用-h2",tabindex:"-1"},[(0,a.Wm)("a",{class:"header-anchor",href:"#配置服务-启用-h2","aria-hidden":"true"},"#"),(0,a.Uk)(" 配置服务，启用 h2")],-1),d=(0,a.Wm)("p",null,"示例配置：",-1),h=(0,a.Wm)("div",{class:"language-nginx ext-nginx line-numbers-mode"},[(0,a.Wm)("pre",{class:"language-nginx"},[(0,a.Wm)("code",null,[(0,a.Wm)("span",{class:"token directive"},[(0,a.Wm)("span",{class:"token keyword"},"server")]),(0,a.Uk)(),(0,a.Wm)("span",{class:"token punctuation"},"{"),(0,a.Uk)("\n    "),(0,a.Wm)("span",{class:"token directive"},[(0,a.Wm)("span",{class:"token keyword"},"listen"),(0,a.Uk)(),(0,a.Wm)("span",{class:"token number"},"443"),(0,a.Uk)(" ssl http2")]),(0,a.Wm)("span",{class:"token punctuation"},";"),(0,a.Uk)("\n\n    "),(0,a.Wm)("span",{class:"token directive"},[(0,a.Wm)("span",{class:"token keyword"},"ssl_certificate"),(0,a.Uk)(" server.crt")]),(0,a.Wm)("span",{class:"token punctuation"},";"),(0,a.Uk)("\n    "),(0,a.Wm)("span",{class:"token directive"},[(0,a.Wm)("span",{class:"token keyword"},"ssl_certificate_key"),(0,a.Uk)(" server.key")]),(0,a.Wm)("span",{class:"token punctuation"},";"),(0,a.Uk)("\n"),(0,a.Wm)("span",{class:"token punctuation"},"}"),(0,a.Uk)("\n")])]),(0,a.Wm)("div",{class:"line-numbers"},[(0,a.Wm)("span",{class:"line-number"},"1"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"2"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"3"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"4"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"5"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"6"),(0,a.Wm)("br")])],-1),b=(0,a.Wm)("p",null,[(0,a.Uk)("我们仅仅需要在 "),(0,a.Wm)("code",null,"listen"),(0,a.Uk)(" 指令中增加 "),(0,a.Wm)("code",null,"http2"),(0,a.Uk)(" 选项即可，非常 easy！")],-1),U=(0,a.Wm)("h3",{id:"配置-ssl",tabindex:"-1"},[(0,a.Wm)("a",{class:"header-anchor",href:"#配置-ssl","aria-hidden":"true"},"#"),(0,a.Uk)(" 配置 SSL")],-1),g=(0,a.Wm)("p",null,"说明以下：",-1),v=(0,a.Wm)("p",null,[(0,a.Uk)("HTTP/2 本身并不是一定需要 SSL 的支持，但当前的浏览器在实现 HTTP/2 时，都选择实现的必须加密传输的版本，因此我们的服务器也需要使用加密传输的方式。其中 HTTP/2 + SSL 称为 "),(0,a.Wm)("code",null,"h2"),(0,a.Uk)("，而非加密的 HTTP/2 称为 "),(0,a.Wm)("code",null,"h2c"),(0,a.Uk)("，可见我们搭建的是 h2 服务器。")],-1),_=(0,a.Wm)("p",null,"如果我们自己来实现 HTTP/2 的客户端，那么可以使用 h2c ，就可以不处理 SSL 相关内容了。",-1),x=(0,a.Wm)("p",null,[(0,a.Uk)("我们还需要配置 SSL，在 "),(0,a.Wm)("code",null,"listen"),(0,a.Uk)(" 指令增加 "),(0,a.Wm)("code",null,"ssl"),(0,a.Uk)(" 选项，并配置证书和密钥，SSL 默认未 443 端口。：")],-1),S=(0,a.Wm)("div",{class:"language-nginx ext-nginx line-numbers-mode"},[(0,a.Wm)("pre",{class:"language-nginx"},[(0,a.Wm)("code",null,[(0,a.Wm)("span",{class:"token directive"},[(0,a.Wm)("span",{class:"token keyword"},"server")]),(0,a.Uk)(),(0,a.Wm)("span",{class:"token punctuation"},"{"),(0,a.Uk)("\n    "),(0,a.Wm)("span",{class:"token directive"},[(0,a.Wm)("span",{class:"token keyword"},"listen"),(0,a.Uk)(),(0,a.Wm)("span",{class:"token number"},"443"),(0,a.Uk)(" ssl http2")]),(0,a.Wm)("span",{class:"token punctuation"},";"),(0,a.Uk)("\n\n    "),(0,a.Wm)("span",{class:"token directive"},[(0,a.Wm)("span",{class:"token keyword"},"ssl_certificate"),(0,a.Uk)(" server.crt")]),(0,a.Wm)("span",{class:"token punctuation"},";"),(0,a.Uk)("\n    "),(0,a.Wm)("span",{class:"token directive"},[(0,a.Wm)("span",{class:"token keyword"},"ssl_certificate_key"),(0,a.Uk)(" server.key")]),(0,a.Wm)("span",{class:"token punctuation"},";"),(0,a.Uk)("\n"),(0,a.Wm)("span",{class:"token punctuation"},"}"),(0,a.Uk)("\n")])]),(0,a.Wm)("div",{class:"line-numbers"},[(0,a.Wm)("span",{class:"line-number"},"1"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"2"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"3"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"4"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"5"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"6"),(0,a.Wm)("br")])],-1),T=(0,a.Uk)("测试环境可以利用 "),f=(0,a.Uk)("mkcert"),w=(0,a.Uk)(" 来安装 CA 和证书，生产环境需要使用公开的 CA 颁发的证书，例如 "),y=(0,a.Uk)("Let's Encrypt"),L=(0,a.Uk)(" 。"),H=(0,a.Wm)("p",null,"当配置 SSL 时，考虑加密安全问题，通常还要做出一些限制，例如加密传输协议的选择，加密算法的选择等：",-1),P=(0,a.Wm)("div",{class:"language-nginx ext-nginx line-numbers-mode"},[(0,a.Wm)("pre",{class:"language-nginx"},[(0,a.Wm)("code",null,[(0,a.Wm)("span",{class:"token directive"},[(0,a.Wm)("span",{class:"token keyword"},"server")]),(0,a.Uk)(),(0,a.Wm)("span",{class:"token punctuation"},"{"),(0,a.Uk)("\n    "),(0,a.Wm)("span",{class:"token directive"},[(0,a.Wm)("span",{class:"token keyword"},"ssl_protocols"),(0,a.Uk)(" TLSv1 TLSv1.1 TLSv1.2")]),(0,a.Wm)("span",{class:"token punctuation"},";"),(0,a.Uk)("    "),(0,a.Wm)("span",{class:"token comment"},"#安全链接可选的加密协议"),(0,a.Uk)("\n    "),(0,a.Wm)("span",{class:"token directive"},[(0,a.Wm)("span",{class:"token keyword"},"ssl_ciphers"),(0,a.Uk)(" ECDHE-RSA-AES128-GCM-SHA256:ECDHE:ECDH:AES:HIGH:!NULL:!aNULL:!MD5:!ADH:!RC4")]),(0,a.Wm)("span",{class:"token punctuation"},";"),(0,a.Uk)("    "),(0,a.Wm)("span",{class:"token comment"},"#加密算法"),(0,a.Uk)("\n    "),(0,a.Wm)("span",{class:"token directive"},[(0,a.Wm)("span",{class:"token keyword"},"ssl_prefer_server_ciphers"),(0,a.Uk)(),(0,a.Wm)("span",{class:"token boolean"},"on")]),(0,a.Wm)("span",{class:"token punctuation"},";"),(0,a.Uk)("   "),(0,a.Wm)("span",{class:"token comment"},"#使用服务器端的首选算法"),(0,a.Uk)("\n"),(0,a.Wm)("span",{class:"token punctuation"},"}"),(0,a.Uk)("\n")])]),(0,a.Wm)("div",{class:"line-numbers"},[(0,a.Wm)("span",{class:"line-number"},"1"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"2"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"3"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"4"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"5"),(0,a.Wm)("br")])],-1),C=(0,a.Wm)("p",null,"还可以增加 ssl 缓存，来提速：",-1),N=(0,a.Wm)("div",{class:"language-nginx ext-nginx line-numbers-mode"},[(0,a.Wm)("pre",{class:"language-nginx"},[(0,a.Wm)("code",null,[(0,a.Wm)("span",{class:"token directive"},[(0,a.Wm)("span",{class:"token keyword"},"server")]),(0,a.Uk)(),(0,a.Wm)("span",{class:"token punctuation"},"{"),(0,a.Uk)("\n    "),(0,a.Wm)("span",{class:"token directive"},[(0,a.Wm)("span",{class:"token keyword"},"ssl_session_timeout"),(0,a.Uk)("  "),(0,a.Wm)("span",{class:"token number"},"5m")]),(0,a.Wm)("span",{class:"token punctuation"},";"),(0,a.Uk)("    "),(0,a.Wm)("span",{class:"token comment"},"# 缓存有效期"),(0,a.Uk)("\n    "),(0,a.Wm)("span",{class:"token directive"},[(0,a.Wm)("span",{class:"token keyword"},"ssl_session_cache"),(0,a.Uk)(" shared:SSL:10m")]),(0,a.Wm)("span",{class:"token punctuation"},";"),(0,a.Uk)("   "),(0,a.Wm)("span",{class:"token comment"},"# 缓存大小"),(0,a.Uk)("\n"),(0,a.Wm)("span",{class:"token punctuation"},"}"),(0,a.Uk)("\n")])]),(0,a.Wm)("div",{class:"line-numbers"},[(0,a.Wm)("span",{class:"line-number"},"1"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"2"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"3"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"4"),(0,a.Wm)("br")])],-1),A=(0,a.Wm)("h3",{id:"浏览器测试",tabindex:"-1"},[(0,a.Wm)("a",{class:"header-anchor",href:"#浏览器测试","aria-hidden":"true"},"#"),(0,a.Uk)(" 浏览器测试")],-1),E=(0,a.Wm)("p",null,[(0,a.Uk)("服务器端配置完毕，可以通过浏览器测试了，目前主流的浏览器都支持 h2 请求。直接在地址栏中 "),(0,a.Wm)("code",null,"https://loacalhost/"),(0,a.Uk)(" 即可，注意是 https。")],-1),z=(0,a.Wm)("p",null,[(0,a.Wm)("img",{src:l,alt:"image-20210817095437651"})],-1),D=(0,a.Wm)("div",{class:"language-text ext-text line-numbers-mode"},[(0,a.Wm)("pre",{class:"language-text"},[(0,a.Wm)("code",null,"\n")]),(0,a.Wm)("div",{class:"line-numbers"},[(0,a.Wm)("span",{class:"line-number"},"1"),(0,a.Wm)("br")])],-1),R=(0,a.Wm)("p",null,"通过 network 监控可见，使用的协议为 h2。没有该列的话，右键勾选。",-1),j=(0,a.Wm)("p",null,"地址栏中出现不安全提示，表示我们使用的是 https，但浏览器端没有相应证书。这个可以忽略，因为我们使用的是测试环境。",-1),G=(0,a.Wm)("p",null,"至此，我们就搭建好了！",-1),I=(0,a.Wm)("p",null,"除了 h2 协议外，我们还可以看到，这么多请求，仅仅使用一个连接。",-1),M=(0,a.Wm)("h3",{id:"为什么浏览器知道需要使用-h2-协议来请求呢",tabindex:"-1"},[(0,a.Wm)("a",{class:"header-anchor",href:"#为什么浏览器知道需要使用-h2-协议来请求呢","aria-hidden":"true"},"#"),(0,a.Uk)(" 为什么浏览器知道需要使用 h2 协议来请求呢？")],-1),O=(0,a.Wm)("p",null,"我们在浏览器端，未作任何关于 h2 的处理，与 HTTP/1.1 的请求方式一致，浏览器是如何区分该服务器是 h2 呢？",-1),V=(0,a.Wm)("p",null,"答案是在 SSL 连接协商阶段，浏览器和服务器确认了应该使用 h2 协议。",-1),q=(0,a.Wm)("p",null,"OpenSSL 1.0.2 后，内置了 ALPN 协议，该协议叫作应用层协议协商，是 TLS 的扩展，利用该协议，可以完成 h2 的协议升级协商工作。早一点还有 NPN 协议也可以协商，但已经过时了。",-1),Y=(0,a.Wm)("h3",{id:"http2-相关配置",tabindex:"-1"},[(0,a.Wm)("a",{class:"header-anchor",href:"#http2-相关配置","aria-hidden":"true"},"#"),(0,a.Uk)(" HTTP2 相关配置")],-1),$=(0,a.Wm)("p",null,"除了以上 nginx 常规配置外，http/2 还支持下面的指令，视具体情况来使用：",-1),B=(0,a.Wm)("div",{class:"language-nginx ext-nginx line-numbers-mode"},[(0,a.Wm)("pre",{class:"language-nginx"},[(0,a.Wm)("code",null,[(0,a.Uk)("http2_body_preread_size\nhttp2_chunk_size\nhttp2_idle_timeout\nhttp2_max_concurrent_pushes\nhttp2_max_concurrent_streams\nhttp2_max_field_size\nhttp2_max_header_size\nhttp2_max_requests\nhttp2_push\t"),(0,a.Wm)("span",{class:"token comment"},"# 推送资源"),(0,a.Uk)("\nhttp2_push_preload\nhttp2_recv_buffer_size\nhttp2_recv_timeout\n")])]),(0,a.Wm)("div",{class:"line-numbers"},[(0,a.Wm)("span",{class:"line-number"},"1"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"2"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"3"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"4"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"5"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"6"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"7"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"8"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"9"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"10"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"11"),(0,a.Wm)("br"),(0,a.Wm)("span",{class:"line-number"},"12"),(0,a.Wm)("br")])],-1),F=(0,a.Wm)("p",null,"还有一个内置变量：",-1),J=(0,a.Wm)("div",{class:"language-nginx ext-nginx line-numbers-mode"},[(0,a.Wm)("pre",{class:"language-nginx"},[(0,a.Wm)("code",null,"$http2\n")]),(0,a.Wm)("div",{class:"line-numbers"},[(0,a.Wm)("span",{class:"line-number"},"1"),(0,a.Wm)("br")])],-1),K={render:function(n,s){const e=(0,a.up)("RouterLink");return(0,a.wg)(),(0,a.j4)(a.HY,null,[m,t,r,c,i,W,p,u,o,k,d,h,b,U,g,v,_,x,S,(0,a.Wm)("p",null,[T,(0,a.Wm)(e,{to:"/tools/mkcert.html"},{default:(0,a.w5)((()=>[f])),_:1}),w,(0,a.Wm)(e,{to:"/tools/lets-encrypt.html"},{default:(0,a.w5)((()=>[y])),_:1}),L]),H,P,C,N,A,E,z,D,R,j,G,I,M,O,V,q,Y,$,B,F,J],64)}}},3445:(n,s,e)=>{n.exports=e.p+"assets/img/image-20210817095437651.0b4e66e1.png"}}]);